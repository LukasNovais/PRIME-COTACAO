<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Frete com ICMS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h2 {
            text-align: center;
            color: #4CAF50;
        }
        /* Layout original de duas colunas */
        .input-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .input-group {
            flex: 1;
        }
        /* Estilo para grupo de inputs que ocupam 100% da largura, como os links de rota */
        .input-group.full-width {
            flex: 0 0 100%; /* Garante que ocupe a largura total */
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .result-group, .history-container {
            margin-top: 20px;
            padding: 10px;
            background-color: #e2f5e2;
            border-radius: 4px;
            font-weight: bold;
        }
        /* Estilo para compactar os resultados */
        .result-group .compact-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .result-group .compact-label {
            flex: 1;
            text-align: left;
        }
        .result-group .compact-value {
            flex: 1;
            text-align: right;
        }
        .history-item {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #ccc;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .button-limpar {
            background-color: #708090; /* Cinza para o botão de limpar */
        }
        .button-limpar:hover {
            background-color: #5a6878;
        }
        /* Estilo para o botão de adicionar/remover destino */
        .waypoint-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        .waypoint-controls button {
            width: auto;
            padding: 2px 5px;
            margin-top: 0;
        }
        .remove-btn {
            background-color: #f44336;
            width: 30px !important;
        }
        .remove-btn:hover {
            background-color: #cc3328;
        }
        /* Estilo para o botão de Adicionar Destino */
        .add-destination-btn {
            background-color: #007bff;
        }
        .add-destination-btn:hover {
            background-color: #0056b3;
        }
        .tab-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            background: #ddd;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            border: 1px solid #ccc;
            border-bottom: none;
        }
        .tab.active {
            background: #fff;
            border-bottom: 1px solid #fff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="tab-container">
        <div class="tab active" onclick="showTab('calculator')">Calculadora</div>
        <div class="tab" onclick="showTab('history')">Histórico</div>
    </div>

    <div id="calculator-content" class="tab-content active">
        <h2>Calculadora de Frete com ICMS</h2>
        
        <div class="input-group full-width">
            <label for="originLink">Link Google Maps (Origem)</label>
            <input type="text" id="originLink" placeholder="Ex: https://goo.gl/maps/..." onchange="calcularRotaGoogle()">
        </div>
        
        <div id="waypointContainer">
            </div>
        
        <div class="input-group full-width">
            <label for="destinationLink">Link Google Maps (Destino Final)</label>
            <input type="text" id="destinationLink" placeholder="Ex: https://goo.gl/maps/..." onchange="calcularRotaGoogle()">
        </div>
        
        <button onclick="adicionarDestinoAdicional()" class="add-destination-btn">Adicionar Outro Destino</button>
        
        <hr style="margin: 20px 0;">

        <div class="input-row">
            <div class="input-group">
                <label for="kmTotal">KM Total (Rota)</label>
                <input type="number" id="kmTotal" readonly placeholder="Calculado pela rota">
            </div>
            <div class="input-group">
                <label for="vlrKmRodado">VLR KM Rodado</label>
                <input type="number" id="vlrKmRodado" placeholder="Preencha o Volume" step="0.01" oninput="calcularFrete()">
            </div>
        </div>
        
        <div class="input-row">
            <div class="input-group">
                <label for="kmGo">KM GO</label>
                <input type="number" id="kmGo" oninput="calcularKmMT(); calcularFrete();">
            </div>
            <div class="input-group">
                <label for="kmMt">KM MT</label>
                <input type="number" id="kmMt" readonly>
            </div>
        </div>
        
        <div class="input-group">
            <label for="volume">Volume (Sugestão VLR KM)</label>
            <input type="number" id="volume" oninput="ajustarVlrKmRodado()">
        </div>
        
        <button onclick="salvarHistorico()">Salvar no Histórico</button>
        <button onclick="limparCampos()" class="button-limpar">Limpar Campos</button>

        <div class="result-group">
            <div class="compact-row">
                <span class="compact-label">Frete GO:</span>
                <span class="compact-value" id="freteGo"></span>
            </div>
            <div class="compact-row">
                <span class="compact-label">Frete MT:</span>
                <span class="compact-value" id="freteMt"></span>
            </div>
            <hr>
            <div class="compact-row">
                <span class="compact-label">Base ICMS GO:</span>
                <span class="compact-value" id="baseIcmsGo"></span>
            </div>
            <div class="compact-row">
                <span class="compact-label">Base ICMS MT:</span>
                <span class="compact-value" id="baseIcmsMt"></span>
            </div>
            <hr>
            <div class="compact-row">
                <span class="compact-label">ICMS GO:</span>
                <span class="compact-value" id="icmsGo"></span>
            </div>
            <div class="compact-row">
                <span class="compact-label">ICMS MT:</span>
                <span class="compact-value" id="icmsMt"></span>
            </div>
            <hr>
            <p style="text-align: right;"><strong>Frete Bruto: <span id="freteBruto"></span></strong></p>
        </div>
    </div>

    <div id="history-content" class="tab-content">
        <h2>Histórico de Cálculos</h2>
        <div id="history-list" class="history-container">
            <p>Nenhum cálculo salvo ainda.</p>
        </div>
        <button onclick="limparHistorico()" style="background-color: #f44336;">Limpar Histórico</button>
    </div>
</div>

<script>
    let waypointCount = 0; // Contador para gerenciar destinos adicionais

    // Funções de utilidade
    function arredondarParaCima(valor) {
        return Math.ceil(valor / 50) * 50;
    }

    function formatarMoeda(valor) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(valor);
    }
    
    // Funções da Rota Dinâmica
    function adicionarDestinoAdicional() {
        waypointCount++;
        const container = document.getElementById('waypointContainer');
        const newDiv = document.createElement('div');
        newDiv.className = 'input-group full-width';
        newDiv.id = `waypoint-group-${waypointCount}`;
        
        // Cria a estrutura para o input e o botão de remover
        const label = document.createElement('label');
        label.setAttribute('for', `waypointLink${waypointCount}`);
        
        const labelText = document.createTextNode(`Link Google Maps (Parada ${waypointCount})`);
        label.appendChild(labelText);

        const removeButton = document.createElement('button');
        removeButton.className = 'remove-btn';
        removeButton.textContent = 'X';
        removeButton.setAttribute('type', 'button');
        removeButton.onclick = () => removerDestinoAdicional(waypointCount);

        const controlsDiv = document.createElement('div');
        controlsDiv.className = 'waypoint-controls';
        controlsDiv.appendChild(label);
        controlsDiv.appendChild(removeButton);

        const input = document.createElement('input');
        input.setAttribute('type', 'text');
        input.setAttribute('id', `waypointLink${waypointCount}`);
        input.setAttribute('placeholder', 'Ex: https://goo.gl/maps/...');
        input.onchange = calcularRotaGoogle;
        
        newDiv.appendChild(controlsDiv);
        newDiv.appendChild(input);
        
        container.appendChild(newDiv);
    }
    
    function removerDestinoAdicional(id) {
        document.getElementById(`waypoint-group-${id}`).remove();
        // Recalcula o total de KM após a remoção
        calcularRotaGoogle(); 
    }

    // Função para simular o cálculo da rota, substituindo a KM Total original
    // **IMPORTANTE: Esta função precisa da integração com a API do Google Maps para calcular a KM real.**
    function calcularRotaGoogle() {
        const origin = document.getElementById('originLink').value.trim();
        const destination = document.getElementById('destinationLink').value.trim();
        const kmTotalInput = document.getElementById('kmTotal');
        
        if (!origin || !destination) {
            kmTotalInput.value = '';
            calcularFrete(); 
            return;
        }

        // Simulação de cálculo de KM: 
        // Em um cenário real, você usaria o Google Maps Directions API aqui.
        // Simulamos um valor fixo de 1500 KM para que os cálculos de frete continuem funcionando.
        let totalDistanceKm = 1500; 
        
        // Se houver waypoints (paradas), você pode simular um aumento de KM.
        const waypoints = [];
        for (let i = 1; i <= waypointCount; i++) {
            const input = document.getElementById(`waypointLink${i}`);
            if (input && input.value.trim()) {
                waypoints.push(input.value.trim());
            }
        }
        
        if (waypoints.length > 0) {
            totalDistanceKm += (waypoints.length * 100); // Aumenta 100km por parada para simulação
        }

        // Fim da Simulação

        kmTotalInput.value = totalDistanceKm.toFixed(0);
        calcularKmMT(); // Recalcula KM MT
        calcularFrete(); // Recalcula o Frete
    }

    // Funções de cálculo
    function ajustarVlrKmRodado() {
        const volume = parseFloat(document.getElementById('volume').value);
        const vlrKmRodadoInput = document.getElementById('vlrKmRodado');
        if (volume === 15000) {
            vlrKmRodadoInput.value = 5.00.toFixed(2);
        } else if (volume === 20000) {
            vlrKmRodadoInput.value = 5.30.toFixed(2);
        } else if (volume === 30000) {
            vlrKmRodadoInput.value = 8.00.toFixed(2);
        } else {
            vlrKmRodadoInput.value = ''; 
            vlrKmRodadoInput.placeholder = 'Negociar valor';
        }
        calcularFrete(); 
    }

    function calcularKmMT() {
        const kmTotal = parseFloat(document.getElementById('kmTotal').value);
        const kmGo = parseFloat(document.getElementById('kmGo').value);
        const kmMtInput = document.getElementById('kmMt');
        if (!isNaN(kmTotal) && !isNaN(kmGo)) {
            const kmMt = kmTotal - kmGo;
            kmMtInput.value = kmMt.toFixed(0);
        } else {
            kmMtInput.value = '';
        }
    }

    function calcularFrete() {
        const kmGo = parseFloat(document.getElementById('kmGo').value);
        const kmMt = parseFloat(document.getElementById('kmMt').value);
        const vlrKmRodado = parseFloat(document.getElementById('vlrKmRodado').value);

        if (isNaN(vlrKmRodado) || vlrKmRodado <= 0 || isNaN(kmGo) || isNaN(kmMt)) {
            const resultados = ['freteGo', 'freteMt', 'baseIcmsGo', 'baseIcmsMt', 'icmsGo', 'icmsMt', 'freteBruto'];
            resultados.forEach(id => document.getElementById(id).textContent = '');
            return;
        }

        // Cálculos para GO (12% ICMS / 88% Frete Líquido)
        const freteLiquidoGo = kmGo * vlrKmRodado;
        const freteBrutoGo = arredondarParaCima(freteLiquidoGo / 0.88);
        const baseIcmsGo = freteLiquidoGo;
        const icmsGo = baseIcmsGo * 0.12;

        // Cálculos para MT (17% ICMS / 83% Frete Líquido)
        const freteLiquidoMt = kmMt * vlrKmRodado;
        const freteBrutoMt = arredondarParaCima(freteLiquidoMt / 0.83);
        const baseIcmsMt = freteLiquidoMt;
        const icmsMt = baseIcmsMt * 0.17;
        
        // Frete Bruto Total - soma dos valores já arredondados
        const freteBrutoTotal = freteBrutoGo + freteBrutoMt;
        
        document.getElementById('freteGo').textContent = formatarMoeda(freteBrutoGo);
        document.getElementById('freteMt').textContent = formatarMoeda(freteBrutoMt);
        document.getElementById('baseIcmsGo').textContent = formatarMoeda(baseIcmsGo);
        document.getElementById('baseIcmsMt').textContent = formatarMoeda(baseIcmsMt);
        document.getElementById('icmsGo').textContent = formatarMoeda(icmsGo);
        document.getElementById('icmsMt').textContent = formatarMoeda(icmsMt);
        document.getElementById('freteBruto').textContent = formatarMoeda(freteBrutoTotal);
    }
    
    // Funções de Histórico
    function salvarHistorico() {
        const freteBruto = document.getElementById('freteBruto').textContent;
        const kmTotal = document.getElementById('kmTotal').value;
        const vlrKmRodado = document.getElementById('vlrKmRodado').value;
        const kmGo = document.getElementById('kmGo').value;
        const kmMt = document.getElementById('kmMt').value;

        if (freteBruto.trim() === '') {
            alert('Não há cálculo para salvar no histórico.');
            return;
        }

        const historico = JSON.parse(localStorage.getItem('freteHistorico') || '[]');
        const novoRegistro = {
            data: new Date().toLocaleString(),
            kmTotal: kmTotal,
            kmGo: kmGo,
            kmMt: kmMt,
            vlrKmRodado: vlrKmRodado,
            freteBruto: freteBruto
        };
        historico.push(novoRegistro);
        localStorage.setItem('freteHistorico', JSON.stringify(historico));
        carregarHistorico();
    }

    function carregarHistorico() {
        const historico = JSON.parse(localStorage.getItem('freteHistorico') || '[]');
        const listaHistorico = document.getElementById('history-list');
        listaHistorico.innerHTML = '';

        if (historico.length === 0) {
            listaHistorico.innerHTML = '<p>Nenhum cálculo salvo ainda.</p>';
        } else {
            historico.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'history-item';
                itemDiv.innerHTML = `
                    <p><strong>Data:</strong> ${item.data}</p>
                    <p><strong>KM Total:</strong> ${item.kmTotal} | <strong>VLR KM:</strong> ${item.vlrKmRodado}</p>
                    <p><strong>Frete Bruto:</strong> ${item.freteBruto}</p>
                `;
                listaHistorico.appendChild(itemDiv);
            });
        }
    }
    
    function limparHistorico() {
        if (confirm('Tem certeza que deseja limpar todo o histórico?')) {
            localStorage.removeItem('freteHistorico');
            carregarHistorico();
        }
    }
    
    // Função de Limpar Campos
    function limparCampos() {
        // Limpa inputs
        document.getElementById('volume').value = '';
        document.getElementById('kmTotal').value = '';
        document.getElementById('kmGo').value = '';
        document.getElementById('kmMt').value = '';
        document.getElementById('vlrKmRodado').value = '';
        document.getElementById('vlrKmRodado').placeholder = 'Negociar valor';

        // Limpa campos da rota
        document.getElementById('originLink').value = '';
        document.getElementById('destinationLink').value = '';
        document.getElementById('waypointContainer').innerHTML = ''; // Limpa destinos adicionais
        waypointCount = 0; // Reseta o contador

        // Limpa campos de resultado
        const resultados = ['freteGo', 'freteMt', 'baseIcmsGo', 'baseIcmsMt', 'icmsGo', 'icmsMt', 'freteBruto'];
        resultados.forEach(id => document.getElementById(id).textContent = '');
    }

    // Funções de Navegação entre abas
    function showTab(tabId) {
        const tabs = document.querySelectorAll('.tab');
        const contents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(tab => tab.classList.remove('active'));
        contents.forEach(content => content.classList.remove('active'));
        
        document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
        document.getElementById(`${tabId}-content`).classList.add('active');
        
        if (tabId === 'history') {
            carregarHistorico();
        }
    }
    
    // Chamada inicial
    window.onload = function() {
        limparCampos();
        carregarHistorico();
    };
</script>

</body>
</html>
