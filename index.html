<div class="container">
    <div class="tab-container">
        <div class="tab active" onclick="showTab('calculator')">Calculadora</div>
        <div class="tab" onclick="showTab('history')">Histórico</div>
    </div>

    <div id="calculator-content" class="tab-content active">
        <h2>Calculadora de Frete com ICMS</h2>

        <div class="route-group">
            <div class="input-group">
                <label for="originLink">Link Google Maps (Origem)</label>
                <input type="text" id="originLink" placeholder="Ex: https://goo.gl/maps/..." onchange="calcularRotaGoogle()">
            </div>
            
            <div id="waypointContainer">
                </div>
            
            <div class="input-group">
                <label for="destinationLink">Link Google Maps (Destino Final)</label>
                <input type="text" id="destinationLink" placeholder="Ex: https://goo.gl/maps/..." onchange="calcularRotaGoogle()">
            </div>
            
            <button onclick="adicionarDestinoAdicional()" style="background-color: #007bff; margin-top: 5px;">Adicionar Outro Destino</button>
        </div>
        
        <hr style="margin: 15px 0;">

        <div class="input-row">
            <div class="input-group">
                <label for="kmTotal">KM Total (Rota)</label>
                <input type="number" id="kmTotal" readonly>
            </div>
            <div class="input-group">
                <label for="vlrKmRodado">VLR KM Rodado</label>
                <input type="number" id="vlrKmRodado" placeholder="Preencha o Volume" step="0.01" oninput="calcularFrete()">
            </div>
        </div>
        
        <div class="input-row">
            <div class="input-group">
                <label for="kmGo">KM GO</label>
                <input type="number" id="kmGo" oninput="calcularKmMT(); calcularFrete();">
            </div>
            <div class="input-group">
                <label for="kmMt">KM MT</label>
                <input type="number" id="kmMt" readonly>
            </div>
        </div>
        
        <div class="input-group">
            <label for="volume">Volume (Sugestão VLR KM)</label>
            <input type="number" id="volume" oninput="ajustarVlrKmRodado()">
        </div>
        
        ```

### 2. Novo JavaScript para a Rota Dinâmica

O código a seguir adiciona as funções para gerenciar os campos dinâmicos e a função `calcularRotaGoogle()`, que é o **ponto de integração** onde você precisará adicionar a chamada à API do Google Maps.

```javascript
<script>
    // **IMPORTANTE: Insira sua Chave de API do Google Maps AQUI**
    // Você precisa carregar a biblioteca do Google Maps com a sua chave.
    // Exemplo: <script src="https://maps.googleapis.com/maps/api/js?key=SUA_CHAVE_API&libraries=routes&callback=initMap" async defer></script>

    let waypointCount = 0; // Contador para gerenciar destinos adicionais

    // Função para adicionar um novo campo de destino adicional
    function adicionarDestinoAdicional() {
        waypointCount++;
        const container = document.getElementById('waypointContainer');
        const newDiv = document.createElement('div');
        newDiv.className = 'input-group';
        newDiv.id = `waypoint-group-${waypointCount}`;
        
        newDiv.innerHTML = `
            <label for="waypointLink${waypointCount}">Link Google Maps (Parada ${waypointCount}) 
                <button onclick="removerDestinoAdicional(${waypointCount})" style="width: auto; padding: 2px 5px; margin-top: 0; background-color: #f44336;">X</button>
            </label>
            <input type="text" id="waypointLink${waypointCount}" placeholder="Ex: https://goo.gl/maps/..." onchange="calcularRotaGoogle()">
        `;
        
        // Insere o novo campo antes do destino final
        container.appendChild(newDiv);
    }
    
    // Função para remover um campo de destino adicional
    function removerDestinoAdicional(id) {
        document.getElementById(`waypoint-group-${id}`).remove();
        // Recalcula o total de KM após a remoção
        calcularRotaGoogle(); 
    }

    // Função PRINCIPAL: Calcula a distância total da rota usando a API do Google Maps
    async function calcularRotaGoogle() {
        const origin = document.getElementById('originLink').value.trim();
        const destination = document.getElementById('destinationLink').value.trim();
        const kmTotalInput = document.getElementById('kmTotal');
        
        if (!origin || !destination) {
            kmTotalInput.value = '';
            calcularFrete(); 
            return;
        }

        // 1. Coleta todos os waypoints dinâmicos
        const waypoints = [];
        for (let i = 1; i <= waypointCount; i++) {
            const input = document.getElementById(`waypointLink${i}`);
            if (input && input.value.trim()) {
                // O Google Maps API usa Waypoint objects. O campo `location` pode ser uma string.
                waypoints.push({
                    location: input.value.trim(),
                    stopover: true 
                });
            }
        }
        
        // 2. Chama a API do Google Maps (AQUI COMEÇA A INTEGRAÇÃO COM A API)
        
        // **ESTE É O TRECHO QUE VOCÊ PRECISA COMPLETAR COM A LÓGICA DA API**
        // A lógica da API deve:
        // a) Chamar google.maps.DirectionsService().route({...}) com origin, destination e waypoints.
        // b) Em caso de sucesso (status OK), somar a distância de cada "leg" da rota.
        // c) O resultado total deve ser armazenado na variável `totalDistanceKm`.
        
        let totalDistanceMeters = 0;
        
        // **EXEMPLO TEÓRICO DA LÓGICA DA API:**
        /*
        const directionsService = new google.maps.DirectionsService();
        try {
            const response = await directionsService.route({
                origin: origin,
                destination: destination,
                waypoints: waypoints,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC 
            });
            
            // Soma a distância de todas as pernas da viagem (legs)
            response.routes[0].legs.forEach(leg => {
                totalDistanceMeters += leg.distance.value; 
            });
            
        } catch (error) {
            console.error('Erro ao calcular rota:', error);
            alert('Não foi possível calcular a rota. Verifique os links e sua Chave de API.');
            kmTotalInput.value = '';
            calcularFrete();
            return;
        }
        */
        
        // Simulação de 1250 km para demonstração, remova após integrar a API
        let totalDistanceKm = 1250; 
        
        // Se a API for integrada, use:
        // let totalDistanceKm = totalDistanceMeters / 1000; 

        // 3. Atualiza o campo KM Total
        kmTotalInput.value = totalDistanceKm.toFixed(0);
        calcularKmMT(); // Recalcula KM MT
        calcularFrete(); // Recalcula o Frete
    }

    // A função calcularKmMT e calcularFrete permanecem as mesmas, 
    // mas agora dependem do campo kmTotal ser preenchido pela função acima.
    
    // ... (restante das funções: ajustarVlrKmRodado, calcularKmMT, calcularFrete, etc.)
    
    // Mantenha as outras funções auxiliares (arredondarParaCima, formatarMoeda) e 
    // as funções de histórico/navegação.
    
    // Altere o window.onload para garantir a limpeza inicial:
    window.onload = function() {
        limparCampos(); 
        carregarHistorico();
    };
</script>
